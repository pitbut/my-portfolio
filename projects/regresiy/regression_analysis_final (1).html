<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí∞ –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É</title>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

header {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, #d4af37, #f4d03f);
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
}

h1 {
    font-size: 2.5em;
    color: #1a1a2e;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.subtitle {
    color: #16213e;
    margin-top: 10px;
    font-size: 1.1em;
}

h2 {
    color: #d4af37;
    margin-bottom: 20px;
    font-size: 1.8em;
}

h3 {
    color: #f4d03f;
    margin: 20px 0 15px 0;
    font-size: 1.3em;
}

h4 {
    color: #d4af37;
    margin: 15px 0 10px 0;
}

.section {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    color: #d4af37;
    font-weight: 600;
}

input[type="number"],
input[type="text"],
input[type="file"],
select,
textarea {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
    transition: all 0.3s;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #d4af37;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
}

button {
    background: linear-gradient(135deg, #d4af37, #f4d03f);
    color: #1a1a2e;
    border: none;
    padding: 15px 35px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
    margin: 5px;
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
}

button:active {
    transform: translateY(-1px);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: linear-gradient(135deg, #0f3460, #16213e);
    color: #d4af37;
    border: 2px solid #d4af37;
}

.btn-danger {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #2980b9, #3498db);
    color: white;
}

.radio-group {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

input[type="radio"],
input[type="checkbox"] {
    width: auto;
    cursor: pointer;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    overflow: hidden;
}

th, td {
    padding: 12px;
    text-align: center;
    border: 1px solid rgba(212, 175, 55, 0.2);
}

th {
    background: rgba(212, 175, 55, 0.3);
    color: #fff;
    font-weight: 700;
}

td input {
    width: 80px;
    padding: 5px;
    text-align: center;
}

.equation-box {
    background: rgba(212, 175, 55, 0.15);
    border: 2px solid #d4af37;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.equation {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 1.1em;
    margin: 10px 0;
    overflow-x: auto;
    color: #f4d03f;
}

.results {
    background: rgba(212, 175, 55, 0.1);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 5px solid #d4af37;
}

.hidden {
    display: none;
}

.grid-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.stats-card {
    background: rgba(212, 175, 55, 0.1);
    padding: 20px;
    border-radius: 10px;
    margin: 10px 0;
    border-left: 5px solid #d4af37;
}

.stats-card h4 {
    color: #d4af37;
    margin-bottom: 10px;
}

.stats-value {
    font-size: 2em;
    color: #f4d03f;
    font-weight: 700;
}

.alert-success {
    background: rgba(46, 204, 113, 0.2);
    border-left: 5px solid #2ecc71;
    color: #2ecc71;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.alert-error {
    background: rgba(231, 76, 60, 0.2);
    border-left: 5px solid #e74c3c;
    color: #e74c3c;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.alert-warning {
    background: rgba(241, 196, 15, 0.2);
    border-left: 5px solid #f1c40f;
    color: #f1c40f;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.info-box {
    background: rgba(52, 152, 219, 0.2);
    border-left: 5px solid #3498db;
    padding: 15px;
    margin: 15px 0;
    border-radius: 5px;
    color: #3498db;
}

.verification-section {
    background: rgba(155, 89, 182, 0.1);
    border: 2px solid #9b59b6;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.coefficient-table td.insignificant {
    color: #888;
    text-decoration: line-through;
}

.coefficient-table td.significant {
    color: #2ecc71;
    font-weight: bold;
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.tab-btn {
    background: rgba(212, 175, 55, 0.2);
    color: #fff;
    border: 2px solid rgba(212, 175, 55, 0.3);
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s;
}

.tab-btn:hover {
    background: rgba(212, 175, 55, 0.3);
    border-color: #d4af37;
}

.tab-btn.active {
    background: linear-gradient(135deg, #d4af37, #f4d03f);
    color: #1a1a2e;
    border-color: #d4af37;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
    cursor: pointer;
    padding: 8px;
    border-radius: 5px;
    transition: background 0.3s;
}

.checkbox-group label:hover {
    background: rgba(212, 175, 55, 0.1);
}

.chart-container {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    min-height: 400px;
}

.chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

canvas {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
}

.modal-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    margin: 2% auto;
    padding: 20px;
    border: 2px solid #d4af37;
    border-radius: 15px;
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
    color: #d4af37;
    float: right;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close:hover {
    color: #f4d03f;
}

.excel-section {
    background: rgba(52, 152, 219, 0.1);
    border: 2px solid #3498db;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

@media (max-width: 768px) {
    .grid-2col,
    .chart-grid {
        grid-template-columns: 1fr;
    }
    h1 {
        font-size: 1.8em;
    }
    .tabs {
        flex-direction: column;
    }
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üí∞ –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h1>
<p class="subtitle">–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É —á–µ—Ä–µ–∑ –Ω–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥</p>
</header>

<!-- –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ -->
<div class="section" id="step1">
<h2>üìã –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞</h2>
<div class="form-group">
<label>–¢–∏–ø —Ñ–∞–∫—Ç–æ—Ä–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</label>
<div class="radio-group">
<label><input type="radio" name="experimentType" value="full" checked>–ü–æ–ª–Ω–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (–ü–§–≠)</label>
<label><input type="radio" name="experimentType" value="fractional">–î—Ä–æ–±–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (–î–§–≠)</label>
</div>
</div>
<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (2-7):</label>
<input type="number" id="numFactors" min="2" max="7" value="3">
</div>
<div class="form-group hidden" id="fractionalOptions">
<label>–†–µ–ø–ª–∏–∫–∞ –¥–ª—è –î–§–≠:</label>
<select id="replicaType">
<option value="1/2">1/2 (–ø–æ–ª–æ–≤–∏–Ω–∞)</option>
<option value="1/4">1/4 (—á–µ—Ç–≤–µ—Ä—Ç—å)</option>
<option value="1/8">1/8 (–≤–æ—Å—å–º–∞—è)</option>
</select>
</div>
<button onclick="setupFactors()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä—ã</button>
</div>

<!-- –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω–µ–π —Ñ–∞–∫—Ç–æ—Ä–æ–≤ -->
<div class="section hidden" id="step2">
<h2>‚öôÔ∏è –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω–µ–π —Ñ–∞–∫—Ç–æ—Ä–æ–≤</h2>
<div id="factorsSetup"></div>
<button onclick="generatePlan()">üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞</button>
</div>

<!-- –®–∞–≥ 3: –í–≤–æ–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
<div class="section hidden" id="step3">
<h2>üìä –®–∞–≥ 3: –í–≤–æ–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>

<!-- –†–∞–±–æ—Ç–∞ —Å Excel -->
<div class="excel-section">
<h3>üì• –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç Excel</h3>
<div class="form-group">
<label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel:</label>
<input type="file" id="excelFile" accept=".xlsx,.xls" onchange="loadExcelData()">
</div>
<button class="btn-info" onclick="downloadExampleTemplate()">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</button>
</div>

<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø—ã—Ç–æ–≤ (2-10):</label>
<input type="number" id="numParallel" min="2" max="10" value="3">
<button onclick="updateDataTable()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
</div>

<div class="info-box">
<strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –ú–∏–Ω–∏–º—É–º 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø—ã—Ç–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. 
–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 5 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π.
</div>

<div id="dataTableContainer"></div>
<button class="btn-success" onclick="calculateRegression()">üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏—é</button>
</div>

<!-- –®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="section hidden" id="step4">
<h2>üìà –®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>

<div class="tabs">
<button class="tab-btn active" onclick="switchTab('equations')">üìê –£—Ä–∞–≤–Ω–µ–Ω–∏—è</button>
<button class="tab-btn" onclick="switchTab('statistics')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
<button class="tab-btn" onclick="switchTab('graphs')">üìà –ì—Ä–∞—Ñ–∏–∫–∏</button>
<button class="tab-btn" onclick="switchTab('optimization')">üéØ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</button>
<button class="tab-btn" onclick="switchTab('verification')">‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
<button class="tab-btn" onclick="switchTab('export')">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –£—Ä–∞–≤–Ω–µ–Ω–∏—è -->
<div id="tab-equations" class="tab-content active">
<h3>1. –†–∞—Å—á–µ—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ (–≤—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)</h3>
<div class="equation-box">
<h4>–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</h4>
<div id="calculatedCodedEquation" class="equation"></div>
</div>
<div class="equation-box">
<h4>–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</h4>
<div id="calculatedNaturalEquation" class="equation"></div>
</div>

<h3>2. –¢–∞–±–ª–∏—Ü–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏</h3>
<div id="coefficientsTable"></div>

<h3>3. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ (—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)</h3>
<div class="equation-box">
<h4>–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</h4>
<div id="finalCodedEquation" class="equation"></div>
</div>
<div class="equation-box">
<h4>–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</h4>
<div id="finalNaturalEquation" class="equation"></div>
</div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div id="tab-statistics" class="tab-content">
<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏</h3>
<div id="statisticalTests"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div id="tab-graphs" class="tab-content">
<h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è:</h3>
<div class="checkbox-group" id="graphSelection"></div>
<div style="margin-top: 15px;">
<button onclick="buildSelectedGraphs()">üé® –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</button>
<button class="btn-secondary" onclick="selectAllGraphs()">‚òëÔ∏è –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
<button class="btn-secondary" onclick="deselectAllGraphs()">‚òê –°–Ω—è—Ç—å –≤—Å–µ</button>
</div>
<div id="graphsContainer" class="chart-grid"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
<div id="tab-optimization" class="tab-content">
<h3>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</h3>
<div class="form-group">
<label>–¶–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</label>
<div class="radio-group">
<label><input type="radio" name="optimGoal" value="max" checked>–ú–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–∏–∫–∞</label>
<label><input type="radio" name="optimGoal" value="min">–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–∏–∫–∞</label>
<label><input type="radio" name="optimGoal" value="target">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</label>
</div>
</div>

<div class="form-group hidden" id="targetValueGroup">
<label>–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞:</label>
<input type="number" id="targetValue" step="0.01">
</div>

<h4>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ñ–∞–∫—Ç–æ—Ä—ã:</h4>
<div id="optimizationConstraints"></div>

<button onclick="performOptimization()">üéØ –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é</button>
<div id="optimizationResults"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞ -->
<div id="tab-verification" class="tab-content">
<div class="verification-section">
<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–º</h3>
<p>–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏</p>

<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫:</label>
<input type="number" id="numVerification" min="1" max="10" value="3">
<button onclick="generateVerificationTable()">–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
</div>

<div id="verificationTableContainer"></div>
<button onclick="performVerification()">‚úì –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
<div id="verificationResults"></div>
</div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞: –≠–∫—Å–ø–æ—Ä—Ç -->
<div id="tab-export" class="tab-content">
<h3>üíæ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
<div class="grid-2col">
<div class="stats-card">
<h4>üìÑ –§–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞</h4>
<button onclick="downloadReportHTML()" class="btn-success">üìÑ HTML –æ—Ç—á–µ—Ç</button>
<button onclick="downloadReportText()" class="btn-info">üìù TXT –æ—Ç—á–µ—Ç</button>
<button onclick="exportToJSON()" class="btn-secondary">üìã JSON –¥–∞–Ω–Ω—ã–µ</button>
<button onclick="exportToExcel()" class="btn-success">üìä Excel —Ñ–∞–π–ª</button>
</div>
<div class="stats-card">
<h4>üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h4>
<label for="jsonFile" class="btn-secondary" style="cursor: pointer; display: inline-block;">
üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
</label>
<input type="file" id="jsonFile" accept=".json" onchange="importFromJSON(event)" style="display:none;">
<p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
</p>
</div>
</div>
</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<div id="chartModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<div id="modalChartContainer"></div>
</div>
</div>

</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let experimentData = {
    type: 'full',
    numFactors: 3,
    factors: [],
    planMatrix: [],
    responses: [],
    coefficients: [],
    significantCoeffs: [],
    calculatedCodedEquation: '',
    calculatedNaturalEquation: '',
    finalCodedEquation: '',
    finalNaturalEquation: '',
    statistics: {},
    verification: {
        performed: false,
        points: [],
        results: []
    }
};

let charts = {};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–æ–±–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
document.querySelectorAll('input[name="experimentType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const fractionalOptions = document.getElementById('fractionalOptions');
        if (e.target.value === 'fractional') {
            fractionalOptions.classList.remove('hidden');
        } else {
            fractionalOptions.classList.add('hidden');
        }
    });
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
document.querySelectorAll('input[name="optimGoal"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const targetGroup = document.getElementById('targetValueGroup');
        if (e.target.value === 'target') {
            targetGroup.classList.remove('hidden');
        } else {
            targetGroup.classList.add('hidden');
        }
    });
});

// –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
function setupFactors() {
    const numFactors = parseInt(document.getElementById('numFactors').value);
    const experimentType = document.querySelector('input[name="experimentType"]:checked').value;
    
    experimentData.numFactors = numFactors;
    experimentData.type = experimentType;
    
    const factorsSetup = document.getElementById('factorsSetup');
    let html = '<table><thead><tr><th>–§–∞–∫—Ç–æ—Ä</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</th><th>–ú–∏–Ω–∏–º—É–º (-1)</th><th>–ú–∞–∫—Å–∏–º—É–º (+1)</th></tr></thead><tbody>';
    
    for (let i = 0; i < numFactors; i++) {
        html += `
        <tr>
            <td><strong>X${i + 1}</strong></td>
            <td><input type="text" id="factorName${i}" value="–§–∞–∫—Ç–æ—Ä ${i + 1}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></td>
            <td><input type="text" id="factorUnit${i}" value="–µ–¥." placeholder="–ï–¥–∏–Ω–∏—Ü–∞"></td>
            <td><input type="number" id="factorMin${i}" value="10" step="0.01"></td>
            <td><input type="number" id="factorMax${i}" value="100" step="0.01"></td>
        </tr>`;
    }
    
    html += '</tbody></table>';
    factorsSetup.innerHTML = html;
    
    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
}

// –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞
function generatePlan() {
    const n = experimentData.numFactors;
    experimentData.factors = [];
    
    for (let i = 0; i < n; i++) {
        experimentData.factors.push({
            name: document.getElementById(`factorName${i}`).value,
            unit: document.getElementById(`factorUnit${i}`).value,
            min: parseFloat(document.getElementById(`factorMin${i}`).value),
            max: parseFloat(document.getElementById(`factorMax${i}`).value)
        });
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ç—Ä–∏—Ü—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if (experimentData.type === 'full') {
        experimentData.planMatrix = generateFullFactorial(n);
    } else {
        const replicaType = document.getElementById('replicaType').value;
        experimentData.planMatrix = generateFractionalFactorial(n, replicaType);
    }
    
    document.getElementById('step3').classList.remove('hidden');
    document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
    updateDataTable();
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
function generateFullFactorial(n) {
    const numRuns = Math.pow(2, n);
    const matrix = [];
    
    for (let i = 0; i < numRuns; i++) {
        const row = [i + 1]; // –ù–æ–º–µ—Ä –æ–ø—ã—Ç–∞
        for (let j = 0; j < n; j++) {
            row.push((Math.floor(i / Math.pow(2, j)) % 2 === 0) ? -1 : 1);
        }
        matrix.push(row);
    }
    
    return matrix;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–æ–±–Ω–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
function generateFractionalFactorial(n, replicaType) {
    const fullMatrix = generateFullFactorial(n);
    
    if (replicaType === '1/2') {
        return fullMatrix.filter((_, idx) => idx % 2 === 0);
    } else if (replicaType === '1/4') {
        return fullMatrix.filter((_, idx) => idx % 4 === 0);
    } else if (replicaType === '1/8') {
        return fullMatrix.filter((_, idx) => idx % 8 === 0);
    }
    
    return fullMatrix;
}

// –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö
function updateDataTable() {
    const numParallel = parseInt(document.getElementById('numParallel').value);
    const n = experimentData.numFactors;
    
    let html = '<table id="dataTable"><thead><tr><th>‚Ññ</th>';
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    for (let i = 0; i < n; i++) {
        html += `<th>X${i + 1}<br>(${experimentData.factors[i].name})</th>`;
    }
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–≤
    for (let i = 0; i < numParallel; i++) {
        html += `<th>Y${i + 1}</th>`;
    }
    
    html += '<th>»≤ (—Å—Ä–µ–¥–Ω–µ–µ)</th></tr></thead><tbody>';
    
    // –°—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    experimentData.planMatrix.forEach((row, idx) => {
        html += `<tr><td>${row[0]}</td>`;
        
        // –§–∞–∫—Ç–æ—Ä—ã
        for (let i = 1; i <= n; i++) {
            const factor = experimentData.factors[i - 1];
            const codedValue = row[i];
            const naturalValue = ((factor.max + factor.min) / 2) + codedValue * ((factor.max - factor.min) / 2);
            html += `<td>${codedValue > 0 ? '+1' : '-1'}<br>(${naturalValue.toFixed(2)})</td>`;
        }
        
        // –û—Ç–∫–ª–∏–∫–∏
        for (let i = 0; i < numParallel; i++) {
            const value = experimentData.responses[idx] && experimentData.responses[idx][i] !== undefined 
                ? experimentData.responses[idx][i] 
                : '';
            html += `<td><input type="number" step="0.001" value="${value}" onchange="updateResponse(${idx}, ${i}, this.value)"></td>`;
        }
        
        // –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const avg = calculateAverage(idx);
        html += `<td><strong>${avg.toFixed(3)}</strong></td>`;
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    document.getElementById('dataTableContainer').innerHTML = html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞
function updateResponse(runIdx, parallelIdx, value) {
    if (!experimentData.responses[runIdx]) {
        experimentData.responses[runIdx] = [];
    }
    experimentData.responses[runIdx][parallelIdx] = parseFloat(value);
    updateDataTable();
}

// –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
function calculateAverage(runIdx) {
    if (!experimentData.responses[runIdx] || experimentData.responses[runIdx].length === 0) {
        return 0;
    }
    const sum = experimentData.responses[runIdx].reduce((a, b) => a + (b || 0), 0);
    const count = experimentData.responses[runIdx].filter(v => v !== undefined && v !== null && v !== '').length;
    return count > 0 ? sum / count : 0;
}

// –†–∞—Å—á–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
function calculateRegression() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
    let hasData = false;
    for (let i = 0; i < experimentData.planMatrix.length; i++) {
        if (experimentData.responses[i] && experimentData.responses[i].some(v => v !== undefined && v !== null && v !== '')) {
            hasData = true;
            break;
        }
    }
    
    if (!hasData) {
        alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!');
        return;
    }
    
    const n = experimentData.numFactors;
    const numRuns = experimentData.planMatrix.length;
    
    // –†–∞—Å—á–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
    experimentData.coefficients = [];
    
    // b0
    let sum = 0;
    for (let i = 0; i < numRuns; i++) {
        sum += calculateAverage(i);
    }
    experimentData.coefficients.push(sum / numRuns);
    
    // bi (–ª–∏–Ω–µ–π–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)
    for (let j = 0; j < n; j++) {
        sum = 0;
        for (let i = 0; i < numRuns; i++) {
            sum += experimentData.planMatrix[i][j + 1] * calculateAverage(i);
        }
        experimentData.coefficients.push(sum / numRuns);
    }
    
    // –†–∞—Å—á–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    for (let j1 = 0; j1 < n; j1++) {
        for (let j2 = j1 + 1; j2 < n; j2++) {
            sum = 0;
            for (let i = 0; i < numRuns; i++) {
                sum += experimentData.planMatrix[i][j1 + 1] * experimentData.planMatrix[i][j2 + 1] * calculateAverage(i);
            }
            experimentData.coefficients.push(sum / numRuns);
        }
    }
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
    calculateStatistics();
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π
    generateAllEquations();
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    displayStatisticalResults();
    displayCoefficientsTable();
    generateGraphSelection();
    generateOptimizationConstraints();
    generateVerificationTable();
    
    document.getElementById('step4').classList.remove('hidden');
    document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
}

// –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function calculateStatistics() {
    const numRuns = experimentData.planMatrix.length;
    const numParallel = parseInt(document.getElementById('numParallel').value);
    const n = experimentData.numFactors;
    
    // 1. –ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞ (–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å –¥–∏—Å–ø–µ—Ä—Å–∏–π)
    const variances = [];
    for (let i = 0; i < numRuns; i++) {
        const responses = experimentData.responses[i] || [];
        const avg = calculateAverage(i);
        let variance = 0;
        let count = 0;
        for (let j = 0; j < numParallel; j++) {
            if (responses[j] !== undefined && responses[j] !== null && responses[j] !== '') {
                variance += Math.pow(responses[j] - avg, 2);
                count++;
            }
        }
        variances.push(count > 1 ? variance / (count - 1) : 0);
    }
    
    const maxVariance = Math.max(...variances);
    const sumVariances = variances.reduce((a, b) => a + b, 0);
    const cochranG = sumVariances > 0 ? maxVariance / sumVariances : 0;
    const cochranCritical = getCochranCritical(numRuns, numParallel - 1);
    const cochranPassed = cochranG <= cochranCritical;
    
    // 2. –î–∏—Å–ø–µ—Ä—Å–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
    const reproductionVariance = variances.reduce((a, b) => a + b, 0) / numRuns;
    
    // 3. –ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞ (–∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)
    const coeffVariance = reproductionVariance / (numRuns * numParallel);
    const sCoeff = Math.sqrt(coeffVariance);
    const df = numRuns * (numParallel - 1);
    const tCritical = getTCritical(df);
    
    experimentData.significantCoeffs = experimentData.coefficients.map(coeff => {
        return Math.abs(coeff) > tCritical * sCoeff;
    });
    
    // 4. –î–∏—Å–ø–µ—Ä—Å–∏—è –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç–∏
    let sumAdequacy = 0;
    for (let i = 0; i < numRuns; i++) {
        const yCalc = predictValue(experimentData.planMatrix[i].slice(1));
        const yExp = calculateAverage(i);
        sumAdequacy += Math.pow(yExp - yCalc, 2);
    }
    const numSignificant = experimentData.significantCoeffs.filter(x => x).length;
    const dfAdequacy = numRuns - numSignificant;
    const adequacyVariance = dfAdequacy > 0 ? (numParallel * sumAdequacy) / dfAdequacy : 0;
    
    // 5. –ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞
    const fisherF = adequacyVariance > 0 ? adequacyVariance / reproductionVariance : 0;
    const fisherCritical = getFCritical(dfAdequacy, df);
    const adequacyPassed = fisherF <= fisherCritical;
    
    // 6. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏ R¬≤
    const yMean = experimentData.planMatrix.reduce((sum, _, i) => sum + calculateAverage(i), 0) / numRuns;
    let ssTotal = 0;
    let ssResidual = 0;
    
    for (let i = 0; i < numRuns; i++) {
        const yExp = calculateAverage(i);
        const yCalc = predictValue(experimentData.planMatrix[i].slice(1));
        ssTotal += Math.pow(yExp - yMean, 2);
        ssResidual += Math.pow(yExp - yCalc, 2);
    }
    
    const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;
    
    experimentData.statistics = {
        cochranG,
        cochranCritical,
        cochranPassed,
        variances,
        reproductionVariance,
        tCritical,
        sCoeff,
        significantCoeffs: experimentData.significantCoeffs,
        adequacyVariance,
        fisherF,
        fisherCritical,
        adequacyPassed,
        rSquared,
        dfAdequacy,
        dfReproduction: df
    };
}

// –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
function predictValue(codedFactors, useOnlySignificant = false) {
    const n = experimentData.numFactors;
    let y = useOnlySignificant && !experimentData.significantCoeffs[0] ? 0 : experimentData.coefficients[0];
    
    // –õ–∏–Ω–µ–π–Ω—ã–µ —á–ª–µ–Ω—ã
    for (let i = 0; i < n; i++) {
        if (!useOnlySignificant || experimentData.significantCoeffs[i + 1]) {
            y += experimentData.coefficients[i + 1] * codedFactors[i];
        }
    }
    
    // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    let coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            if (!useOnlySignificant || experimentData.significantCoeffs[coeffIdx]) {
                y += experimentData.coefficients[coeffIdx] * codedFactors[i] * codedFactors[j];
            }
            coeffIdx++;
        }
    }
    
    return y;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π
function generateAllEquations() {
    const n = experimentData.numFactors;
    
    // –†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
    let codedEq = `Y = ${experimentData.coefficients[0].toFixed(4)}`;
    for (let i = 0; i < n; i++) {
        const sign = experimentData.coefficients[i + 1] >= 0 ? ' + ' : ' - ';
        codedEq += `${sign}${Math.abs(experimentData.coefficients[i + 1]).toFixed(4)}¬∑X${i + 1}`;
    }
    
    let coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            const sign = experimentData.coefficients[coeffIdx] >= 0 ? ' + ' : ' - ';
            codedEq += `${sign}${Math.abs(experimentData.coefficients[coeffIdx]).toFixed(4)}¬∑X${i + 1}X${j + 1}`;
            coeffIdx++;
        }
    }
    
    experimentData.calculatedCodedEquation = codedEq;
    
    // –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ)
    let finalCodedEq = '';
    if (experimentData.significantCoeffs[0]) {
        finalCodedEq = `Y = ${experimentData.coefficients[0].toFixed(4)}`;
    }
    
    for (let i = 0; i < n; i++) {
        if (experimentData.significantCoeffs[i + 1]) {
            const sign = experimentData.coefficients[i + 1] >= 0 ? ' + ' : ' - ';
            if (finalCodedEq === '') {
                finalCodedEq = `Y = ${experimentData.coefficients[i + 1].toFixed(4)}¬∑X${i + 1}`;
            } else {
                finalCodedEq += `${sign}${Math.abs(experimentData.coefficients[i + 1]).toFixed(4)}¬∑X${i + 1}`;
            }
        }
    }
    
    coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            if (experimentData.significantCoeffs[coeffIdx]) {
                const sign = experimentData.coefficients[coeffIdx] >= 0 ? ' + ' : ' - ';
                if (finalCodedEq === '') {
                    finalCodedEq = `Y = ${experimentData.coefficients[coeffIdx].toFixed(4)}¬∑X${i + 1}X${j + 1}`;
                } else {
                    finalCodedEq += `${sign}${Math.abs(experimentData.coefficients[coeffIdx]).toFixed(4)}¬∑X${i + 1}X${j + 1}`;
                }
            }
            coeffIdx++;
        }
    }
    
    if (finalCodedEq === '') finalCodedEq = 'Y = 0 (–Ω–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)';
    experimentData.finalCodedEquation = finalCodedEq;
    
    // –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
    experimentData.calculatedNaturalEquation = convertToNatural(false);
    experimentData.finalNaturalEquation = convertToNatural(true);
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('calculatedCodedEquation').textContent = experimentData.calculatedCodedEquation;
    document.getElementById('calculatedNaturalEquation').textContent = experimentData.calculatedNaturalEquation;
    document.getElementById('finalCodedEquation').textContent = experimentData.finalCodedEquation;
    document.getElementById('finalNaturalEquation').textContent = experimentData.finalNaturalEquation;
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
function convertToNatural(useOnlySignificant) {
    const n = experimentData.numFactors;
    const coeffs = useOnlySignificant ? 
        experimentData.coefficients.map((c, i) => experimentData.significantCoeffs[i] ? c : 0) :
        experimentData.coefficients;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
    let naturalCoeffs = [coeffs[0]];
    
    // –†–∞—Å—á–µ—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
    for (let i = 0; i < n; i++) {
        const factor = experimentData.factors[i];
        const center = (factor.max + factor.min) / 2;
        const range = (factor.max - factor.min) / 2;
        
        naturalCoeffs[0] -= coeffs[i + 1] * center / range;
        naturalCoeffs.push(coeffs[i + 1] / range);
    }
    
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
    let eq = `Y = ${naturalCoeffs[0].toFixed(4)}`;
    
    for (let i = 0; i < n; i++) {
        if (Math.abs(naturalCoeffs[i + 1]) > 1e-10) {
            const sign = naturalCoeffs[i + 1] >= 0 ? ' + ' : ' - ';
            eq += `${sign}${Math.abs(naturalCoeffs[i + 1]).toFixed(4)}¬∑${experimentData.factors[i].name}`;
        }
    }
    
    return eq;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function displayStatisticalResults() {
    const stats = experimentData.statistics;
    
    let html = '<div class="grid-2col">';
    
    // –ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞
    html += '<div class="stats-card">';
    html += '<h4>1. –ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞ (–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å –¥–∏—Å–ø–µ—Ä—Å–∏–π)</h4>';
    html += `<p><strong>G —Ä–∞—Å—á–µ—Ç–Ω–æ–µ:</strong> ${stats.cochranG.toFixed(4)}</p>`;
    html += `<p><strong>G –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ:</strong> ${stats.cochranCritical.toFixed(4)}</p>`;
    html += stats.cochranPassed ? 
        '<div class="alert-success">‚úì –î–∏—Å–ø–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã</div>' :
        '<div class="alert-error">‚úó –î–∏—Å–ø–µ—Ä—Å–∏–∏ –Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω—ã</div>';
    html += '</div>';
    
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏
    html += '<div class="stats-card">';
    html += '<h4>2. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏</h4>';
    html += `<div class="stats-value">R¬≤ = ${stats.rSquared.toFixed(4)}</div>`;
    html += `<p>${(stats.rSquared * 100).toFixed(2)}% –æ–±—ä—è—Å–Ω–µ–Ω–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏</p>`;
    if (stats.rSquared > 0.9) {
        html += '<div class="alert-success">–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏</div>';
    } else if (stats.rSquared > 0.7) {
        html += '<div class="alert-success">–•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏</div>';
    } else {
        html += '<div class="alert-warning">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</div>';
    }
    html += '</div>';
    
    // –ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞
    html += '<div class="stats-card">';
    html += '<h4>3. –ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞ (–∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)</h4>';
    html += `<p><strong>t –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ:</strong> ${stats.tCritical.toFixed(3)}</p>`;
    html += `<p><strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞:</strong> ${stats.sCoeff.toFixed(4)}</p>`;
    const numSignificant = stats.significantCoeffs.filter(x => x).length;
    html += `<p><strong>–ó–Ω–∞—á–∏–º—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤:</strong> ${numSignificant} –∏–∑ ${experimentData.coefficients.length}</p>`;
    html += '</div>';
    
    // –ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞
    html += '<div class="stats-card">';
    html += '<h4>4. –ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞ (–∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏)</h4>';
    html += `<p><strong>F —Ä–∞—Å—á–µ—Ç–Ω–æ–µ:</strong> ${stats.fisherF.toFixed(4)}</p>`;
    html += `<p><strong>F –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ:</strong> ${stats.fisherCritical.toFixed(4)}</p>`;
    html += stats.adequacyPassed ?
        '<div class="alert-success">‚úì –ú–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞</div>' :
        '<div class="alert-error">‚úó –ú–æ–¥–µ–ª—å –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞</div>';
    html += '</div>';
    
    html += '</div>';
    
    document.getElementById('statisticalTests').innerHTML = html;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
function displayCoefficientsTable() {
    const n = experimentData.numFactors;
    const stats = experimentData.statistics;
    
    let html = '<table class="coefficient-table"><thead><tr>';
    html += '<th>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th>|t|</th><th>–ó–Ω–∞—á–∏–º–æ—Å—Ç—å</th></tr></thead><tbody>';
    
    // –°–≤–æ–±–æ–¥–Ω—ã–π —á–ª–µ–Ω
    const tValue0 = Math.abs(experimentData.coefficients[0] / stats.sCoeff);
    html += `<tr class="${experimentData.significantCoeffs[0] ? 'significant' : 'insignificant'}">`;
    html += `<td>b‚ÇÄ</td>`;
    html += `<td>${experimentData.coefficients[0].toFixed(4)}</td>`;
    html += `<td>${tValue0.toFixed(3)}</td>`;
    html += `<td>${experimentData.significantCoeffs[0] ? '‚úì –ó–Ω–∞—á–∏–º' : '‚úó –ù–µ–∑–Ω–∞—á–∏–º'}</td>`;
    html += '</tr>';
    
    // –õ–∏–Ω–µ–π–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
    for (let i = 0; i < n; i++) {
        const tValue = Math.abs(experimentData.coefficients[i + 1] / stats.sCoeff);
        html += `<tr class="${experimentData.significantCoeffs[i + 1] ? 'significant' : 'insignificant'}">`;
        html += `<td>b‚Çç${i + 1}‚Çé (X${i + 1})</td>`;
        html += `<td>${experimentData.coefficients[i + 1].toFixed(4)}</td>`;
        html += `<td>${tValue.toFixed(3)}</td>`;
        html += `<td>${experimentData.significantCoeffs[i + 1] ? '‚úì –ó–Ω–∞—á–∏–º' : '‚úó –ù–µ–∑–Ω–∞—á–∏–º'}</td>`;
        html += '</tr>';
    }
    
    // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    let coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            const tValue = Math.abs(experimentData.coefficients[coeffIdx] / stats.sCoeff);
            html += `<tr class="${experimentData.significantCoeffs[coeffIdx] ? 'significant' : 'insignificant'}">`;
            html += `<td>b‚Çç${i + 1}${j + 1}‚Çé (X${i + 1}X${j + 1})</td>`;
            html += `<td>${experimentData.coefficients[coeffIdx].toFixed(4)}</td>`;
            html += `<td>${tValue.toFixed(3)}</td>`;
            html += `<td>${experimentData.significantCoeffs[coeffIdx] ? '‚úì –ó–Ω–∞—á–∏–º' : '‚úó –ù–µ–∑–Ω–∞—á–∏–º'}</td>`;
            html += '</tr>';
            coeffIdx++;
        }
    }
    
    html += '</tbody></table>';
    html += `<p style="margin-top: 15px;"><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–∏–º—ã–º, –µ—Å–ª–∏ |t| > t_–∫—Ä–∏—Ç = ${stats.tCritical.toFixed(3)}</p>`;
    
    document.getElementById('coefficientsTable').innerHTML = html;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function generateGraphSelection() {
    const n = experimentData.numFactors;
    const container = document.getElementById('graphSelection');
    container.innerHTML = '';
    
    // 2D –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="checkbox" class="graph-check" value="2d-${i}-${j}">
                2D –≥—Ä–∞—Ñ–∏–∫: X${i+1} vs X${j+1} (${experimentData.factors[i].name} vs ${experimentData.factors[j].name})
            `;
            container.appendChild(label);
        }
    }
    
    // 3D –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    if (n >= 2) {
        for (let i = 0; i < n; i++) {
            for (let j = i + 1; j < n; j++) {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="graph-check" value="3d-${i}-${j}" checked>
                    3D –≥—Ä–∞—Ñ–∏–∫: Y = f(X${i+1}, X${j+1})
                `;
                container.appendChild(label);
            }
        }
        
        // –ò–∑–æ–ª–∏–Ω–∏–∏ (–∫–æ–Ω—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏) –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        for (let i = 0; i < n; i++) {
            for (let j = i + 1; j < n; j++) {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="graph-check" value="contour-${i}-${j}" checked>
                    –ò–∑–æ–ª–∏–Ω–∏–∏: Y = f(X${i+1}, X${j+1})
                `;
                container.appendChild(label);
            }
        }
    }
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
function buildSelectedGraphs() {
    const selected = Array.from(document.querySelectorAll('.graph-check:checked')).map(cb => cb.value);
    const container = document.getElementById('graphsContainer');
    container.innerHTML = '';
    
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    Object.values(charts).forEach(chart => {
        if (chart && chart.destroy) chart.destroy();
    });
    charts = {};
    
    if (selected.length === 0) {
        alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥—Ä–∞—Ñ–∏–∫');
        return;
    }
    
    selected.forEach(graphType => {
        const [type, i, j] = graphType.split('-');
        const idx1 = parseInt(i);
        const idx2 = parseInt(j);
        
        if (type === '2d') {
            build2DGraph(idx1, idx2, container);
        } else if (type === '3d') {
            build3DGraph(idx1, idx2, container);
        } else if (type === 'contour') {
            buildContourGraph(idx1, idx2, container);
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –æ—Ç–∫–ª–∏–∫–æ–≤
function buildResponseBarChart(container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = '<canvas id="responseBarChart"></canvas>';
    container.appendChild(div);
    
    const ctx = document.getElementById('responseBarChart').getContext('2d');
    
    const labels = experimentData.planMatrix.map(row => `–û–ø—ã—Ç ${row[0]}`);
    const data = experimentData.planMatrix.map((_, i) => calculateAverage(i));
    
    charts.responseBar = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–°—Ä–µ–¥–Ω–∏–π –æ—Ç–∫–ª–∏–∫',
                data: data,
                backgroundColor: 'rgba(212, 175, 55, 0.7)',
                borderColor: 'rgba(212, 175, 55, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–∫–ª–∏–∫–æ–≤ –ø–æ –æ–ø—ã—Ç–∞–º',
                    font: { size: 16 }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: '–û—Ç–∫–ª–∏–∫ (Y)'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: –í–ª–∏—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
function buildFactorsEffectChart(container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = '<canvas id="factorsEffectChart"></canvas>';
    container.appendChild(div);
    
    const ctx = document.getElementById('factorsEffectChart').getContext('2d');
    const n = experimentData.numFactors;
    
    const labels = experimentData.factors.map((f, i) => `X${i + 1}: ${f.name}`);
    const data = experimentData.coefficients.slice(1, n + 1).map(Math.abs);
    const colors = experimentData.significantCoeffs.slice(1, n + 1).map(sig => 
        sig ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.5)'
    );
    
    charts.factorsEffect = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ',
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.7', '1').replace('0.5', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                title: {
                    display: true,
                    text: '–í–ª–∏—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –Ω–∞ –æ—Ç–∫–ª–∏–∫',
                    font: { size: 16 }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: –ü—Ä–æ–≥–Ω–æ–∑ vs –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
function buildPredictedActualChart(container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = '<canvas id="predictedActualChart"></canvas>';
    container.appendChild(div);
    
    const ctx = document.getElementById('predictedActualChart').getContext('2d');
    
    const actual = experimentData.planMatrix.map((_, i) => calculateAverage(i));
    const predicted = experimentData.planMatrix.map(row => predictValue(row.slice(1), true));
    
    const minVal = Math.min(...actual, ...predicted);
    const maxVal = Math.max(...actual, ...predicted);
    
    charts.predictedActual = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏',
                data: actual.map((y, i) => ({ x: y, y: predicted[i] })),
                backgroundColor: 'rgba(212, 175, 55, 0.7)',
                borderColor: 'rgba(212, 175, 55, 1)',
                pointRadius: 6
            }, {
                label: '–ò–¥–µ–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è',
                data: [{ x: minVal, y: minVal }, { x: maxVal, y: maxVal }],
                type: 'line',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 2,
                pointRadius: 0,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ vs –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è',
                    font: { size: 16 }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: –û—Å—Ç–∞—Ç–∫–∏
function buildResidualsChart(container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = '<canvas id="residualsChart"></canvas>';
    container.appendChild(div);
    
    const ctx = document.getElementById('residualsChart').getContext('2d');
    
    const residuals = experimentData.planMatrix.map((row, i) => {
        const actual = calculateAverage(i);
        const predicted = predictValue(row.slice(1), true);
        return actual - predicted;
    });
    
    const labels = experimentData.planMatrix.map(row => `–û–ø—ã—Ç ${row[0]}`);
    
    charts.residuals = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–û—Å—Ç–∞—Ç–∫–∏',
                data: residuals,
                backgroundColor: residuals.map(r => r >= 0 ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)'),
                borderColor: residuals.map(r => r >= 0 ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–ì—Ä–∞—Ñ–∏–∫ –æ—Å—Ç–∞—Ç–∫–æ–≤ (–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç - –ü—Ä–æ–≥–Ω–æ–∑)',
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: '–û—Å—Ç–∞—Ç–æ–∫'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: –ü–∞—Ä–µ—Ç–æ
function buildParetoChart(container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = '<canvas id="paretoChart"></canvas>';
    container.appendChild(div);
    
    const ctx = document.getElementById('paretoChart').getContext('2d');
    const n = experimentData.numFactors;
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å –º–µ—Ç–∫–∞–º–∏
    const items = [];
    
    // –°–≤–æ–±–æ–¥–Ω—ã–π —á–ª–µ–Ω –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    for (let i = 0; i < n; i++) {
        items.push({
            label: `X${i + 1}`,
            value: Math.abs(experimentData.coefficients[i + 1]),
            significant: experimentData.significantCoeffs[i + 1]
        });
    }
    
    let coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            items.push({
                label: `X${i + 1}X${j + 1}`,
                value: Math.abs(experimentData.coefficients[coeffIdx]),
                significant: experimentData.significantCoeffs[coeffIdx]
            });
            coeffIdx++;
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    items.sort((a, b) => b.value - a.value);
    
    const labels = items.map(item => item.label);
    const values = items.map(item => item.value);
    const colors = items.map(item => item.significant ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.5)');
    
    charts.pareto = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',
                data: values,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.7', '1').replace('0.5', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–î–∏–∞–≥—Ä–∞–º–º–∞ –ü–∞—Ä–µ—Ç–æ (—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏)',
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞'
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∫—Ç–æ—Ä–∞
function buildFactorDependencyChart(container, factorIdx) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    div.innerHTML = `<div id="factorChart${factorIdx}"></div>`;
    container.appendChild(div);
    
    const factor = experimentData.factors[factorIdx];
    const step = (factor.max - factor.min) / 20;
    const xValues = [];
    const yValues = [];
    
    // –§–∏–∫—Å–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–∞ –Ω—É–ª–µ–≤–æ–º —É—Ä–æ–≤–Ω–µ
    const baseFactors = new Array(experimentData.numFactors).fill(0);
    
    for (let x = factor.min; x <= factor.max; x += step) {
        const codedValue = 2 * (x - factor.min) / (factor.max - factor.min) - 1;
        baseFactors[factorIdx] = codedValue;
        xValues.push(x);
        yValues.push(predictValue(baseFactors, true));
    }
    
    const trace = {
        x: xValues,
        y: yValues,
        mode: 'lines+markers',
        name: '–ü—Ä–æ–≥–Ω–æ–∑',
        line: { color: '#d4af37', width: 3 },
        marker: { size: 6, color: '#f4d03f' }
    };
    
    const layout = {
        title: `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç–∫–ª–∏–∫–∞ –æ—Ç ${factor.name}`,
        xaxis: { title: `${factor.name} (${factor.unit})` },
        yaxis: { title: '–û—Ç–∫–ª–∏–∫ (Y)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.9)',
        font: { color: '#333' }
    };
    
    Plotly.newPlot(`factorChart${factorIdx}`, [trace], layout);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
function generateOptimizationConstraints() {
    const n = experimentData.numFactors;
    let html = '<table><thead><tr><th>–§–∞–∫—Ç–æ—Ä</th><th>–ú–∏–Ω–∏–º—É–º</th><th>–ú–∞–∫—Å–∏–º—É–º</th></tr></thead><tbody>';
    
    for (let i = 0; i < n; i++) {
        const factor = experimentData.factors[i];
        html += `<tr>
            <td>${factor.name}</td>
            <td><input type="number" id="optMin${i}" value="${factor.min}" step="0.01"></td>
            <td><input type="number" id="optMax${i}" value="${factor.max}" step="0.01"></td>
        </tr>`;
    }
    
    html += '</tbody></table>';
    document.getElementById('optimizationConstraints').innerHTML = html;
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function selectAllGraphs() {
    document.querySelectorAll('.graph-check').forEach(cb => cb.checked = true);
}

// –°–Ω—è—Ç—å –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function deselectAllGraphs() {
    document.querySelectorAll('.graph-check').forEach(cb => cb.checked = false);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
function encodeValue(real, min, max) {
    return (2 * real - max - min) / (max - min);
}

function decodeValue(coded, min, max) {
    return (max + min) / 2 + coded * (max - min) / 2;
}

// –ì—Ä–∞—Ñ–∏–∫: 2D scatter –¥–ª—è –ø–∞—Ä—ã —Ñ–∞–∫—Ç–æ—Ä–æ–≤
function build2DGraph(factorIdx1, factorIdx2, container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    const canvas = document.createElement('canvas');
    div.appendChild(canvas);
    container.appendChild(div);
    
    const ctx = canvas.getContext('2d');
    const data = experimentData.planMatrix.map((row, idx) => ({
        x: decodeValue(row[factorIdx1 + 1], experimentData.factors[factorIdx1].min, experimentData.factors[factorIdx1].max),
        y: decodeValue(row[factorIdx2 + 1], experimentData.factors[factorIdx2].min, experimentData.factors[factorIdx2].max),
        response: calculateAverage(idx)
    }));
    
    const f1 = experimentData.factors[factorIdx1];
    const f2 = experimentData.factors[factorIdx2];
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: `Y = f(${f1.name}, ${f2.name})`,
                data: data.map(d => ({ x: d.x, y: d.y })),
                backgroundColor: data.map(d => {
                    const normalized = (d.response - Math.min(...data.map(p => p.response))) /
                        (Math.max(...data.map(p => p.response)) - Math.min(...data.map(p => p.response)));
                    return `rgba(212, 175, 55, ${0.3 + normalized * 0.7})`;
                }),
                borderColor: '#d4af37',
                borderWidth: 2,
                pointRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `2D –≥—Ä–∞—Ñ–∏–∫: ${f1.name} vs ${f2.name}`,
                    font: { size: 16 },
                    color: '#333'
                },
                legend: {
                    labels: { color: '#333' }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: `${f1.name} (${f1.unit})`,
                        color: '#333'
                    },
                    ticks: { color: '#333' }
                },
                y: {
                    title: {
                        display: true,
                        text: `${f2.name} (${f2.unit})`,
                        color: '#333'
                    },
                    ticks: { color: '#333' }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫: 3D –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
function build3DGraph(factorIdx1, factorIdx2, container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    container.appendChild(div);
    
    const resolution = 25;
    const x = [];
    const y = [];
    const z = [];
    
    const f1 = experimentData.factors[factorIdx1];
    const f2 = experimentData.factors[factorIdx2];
    
    for (let i = 0; i <= resolution; i++) {
        const x_row = [];
        const y_row = [];
        const z_row = [];
        
        for (let j = 0; j <= resolution; j++) {
            const x_val = f1.min + (f1.max - f1.min) * i / resolution;
            const y_val = f2.min + (f2.max - f2.min) * j / resolution;
            
            const coded1 = encodeValue(x_val, f1.min, f1.max);
            const coded2 = encodeValue(y_val, f2.min, f2.max);
            
            const factors = new Array(experimentData.numFactors).fill(0);
            factors[factorIdx1] = coded1;
            factors[factorIdx2] = coded2;
            
            const z_val = predictValue(factors, true);
            
            x_row.push(x_val);
            y_row.push(y_val);
            z_row.push(z_val);
        }
        
        x.push(x_row);
        y.push(y_row);
        z.push(z_row);
    }
    
    const data = [{
        type: 'surface',
        x: x,
        y: y,
        z: z,
        colorscale: [
            [0, '#0f3460'],
            [0.5, '#d4af37'],
            [1, '#f4d03f']
        ],
        showscale: true,
        contours: {
            z: {
                show: true,
                usecolormap: true,
                highlightcolor: "#42f462",
                project: { z: true }
            }
        }
    }];
    
    const layout = {
        title: {
            text: `3D –≥—Ä–∞—Ñ–∏–∫: Y = f(${f1.name}, ${f2.name})`,
            font: { size: 16 }
        },
        scene: {
            xaxis: { 
                title: `${f1.name} (${f1.unit})`,
                backgroundcolor: "rgb(230, 230,230)",
                gridcolor: "rgb(255, 255, 255)",
                showbackground: true,
                zerolinecolor: "rgb(255, 255, 255)"
            },
            yaxis: { 
                title: `${f2.name} (${f2.unit})`,
                backgroundcolor: "rgb(230, 230,230)",
                gridcolor: "rgb(255, 255, 255)",
                showbackground: true,
                zerolinecolor: "rgb(255, 255, 255)"
            },
            zaxis: { 
                title: '–û—Ç–∫–ª–∏–∫ Y',
                backgroundcolor: "rgb(230, 230,230)",
                gridcolor: "rgb(255, 255, 255)",
                showbackground: true,
                zerolinecolor: "rgb(255, 255, 255)"
            },
            camera: {
                eye: { x: 1.5, y: 1.5, z: 1.3 }
            }
        },
        autosize: true,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.9)'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
    };
    
    Plotly.newPlot(div, data, layout, config);
}

// –ì—Ä–∞—Ñ–∏–∫: –ò–∑–æ–ª–∏–Ω–∏–∏ (–∫–æ–Ω—Ç—É—Ä–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫)
function buildContourGraph(factorIdx1, factorIdx2, container) {
    const div = document.createElement('div');
    div.className = 'chart-container';
    container.appendChild(div);
    
    const resolution = 30;
    const x = [];
    const y = [];
    const z = [];
    
    const f1 = experimentData.factors[factorIdx1];
    const f2 = experimentData.factors[factorIdx2];
    
    for (let i = 0; i <= resolution; i++) {
        const z_row = [];
        const x_val = f1.min + (f1.max - f1.min) * i / resolution;
        
        if (i === 0) {
            for (let j = 0; j <= resolution; j++) {
                y.push(f2.min + (f2.max - f2.min) * j / resolution);
            }
        }
        
        x.push(x_val);
        
        for (let j = 0; j <= resolution; j++) {
            const y_val = f2.min + (f2.max - f2.min) * j / resolution;
            
            const coded1 = encodeValue(x_val, f1.min, f1.max);
            const coded2 = encodeValue(y_val, f2.min, f2.max);
            
            const factors = new Array(experimentData.numFactors).fill(0);
            factors[factorIdx1] = coded1;
            factors[factorIdx2] = coded2;
            
            const z_val = predictValue(factors, true);
            z_row.push(z_val);
        }
        
        z.push(z_row);
    }
    
    const data = [{
        type: 'contour',
        x: y,
        y: x,
        z: z,
        colorscale: [
            [0, '#0f3460'],
            [0.25, '#16213e'],
            [0.5, '#d4af37'],
            [0.75, '#f4d03f'],
            [1, '#f9e79f']
        ],
        contours: {
            coloring: 'heatmap',
            showlabels: true,
            labelfont: {
                family: 'Raleway',
                size: 12,
                color: 'white',
            }
        },
        colorbar: {
            title: 'Y',
            titleside: 'right',
            titlefont: {
                size: 14,
                family: 'Arial, sans-serif'
            }
        }
    }];
    
    const layout = {
        title: {
            text: `–ò–∑–æ–ª–∏–Ω–∏–∏: Y = f(${f1.name}, ${f2.name})`,
            font: { size: 16 }
        },
        xaxis: {
            title: `${f2.name} (${f2.unit})`,
            showgrid: true,
            zeroline: true
        },
        yaxis: {
            title: `${f1.name} (${f1.unit})`,
            showgrid: true,
            zeroline: true
        },
        autosize: true,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.9)'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
    };
    
    Plotly.newPlot(div, data, layout, config);
}

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
function performOptimization() {
    const goal = document.querySelector('input[name="optimGoal"]:checked').value;
    const n = experimentData.numFactors;
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    const constraints = [];
    for (let i = 0; i < n; i++) {
        constraints.push({
            min: parseFloat(document.getElementById(`optMin${i}`).value),
            max: parseFloat(document.getElementById(`optMax${i}`).value)
        });
    }
    
    // –ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º—É–º–∞ –º–µ—Ç–æ–¥–æ–º —Å–µ—Ç–∫–∏
    const gridSize = 20;
    let bestValue = goal === 'max' ? -Infinity : Infinity;
    let bestPoint = null;
    
    function searchGrid(factors, depth) {
        if (depth === n) {
            const codedFactors = factors.map((val, i) => {
                const factor = experimentData.factors[i];
                return 2 * (val - factor.min) / (factor.max - factor.min) - 1;
            });
            
            const y = predictValue(codedFactors, true);
            
            if (goal === 'max') {
                if (y > bestValue) {
                    bestValue = y;
                    bestPoint = [...factors];
                }
            } else if (goal === 'min') {
                if (y < bestValue) {
                    bestValue = y;
                    bestPoint = [...factors];
                }
            } else if (goal === 'target') {
                const target = parseFloat(document.getElementById('targetValue').value);
                if (Math.abs(y - target) < Math.abs(bestValue - target)) {
                    bestValue = y;
                    bestPoint = [...factors];
                }
            }
            return;
        }
        
        const step = (constraints[depth].max - constraints[depth].min) / gridSize;
        for (let x = constraints[depth].min; x <= constraints[depth].max; x += step) {
            factors[depth] = x;
            searchGrid(factors, depth + 1);
        }
    }
    
    searchGrid(new Array(n).fill(0), 0);
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    let html = '<div class="results">';
    html += `<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h4>`;
    html += `<p><strong>–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞:</strong> ${bestValue.toFixed(4)}</p>`;
    html += '<h5>–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ—Ä–æ–≤:</h5><ul>';
    
    for (let i = 0; i < n; i++) {
        const factor = experimentData.factors[i];
        html += `<li><strong>${factor.name}:</strong> ${bestPoint[i].toFixed(3)} ${factor.unit}</li>`;
    }
    
    html += '</ul></div>';
    document.getElementById('optimizationResults').innerHTML = html;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
function generateVerificationTable() {
    const numVer = parseInt(document.getElementById('numVerification').value);
    const n = experimentData.numFactors;
    
    let html = '<table><thead><tr><th>–¢–æ—á–∫–∞</th>';
    
    for (let i = 0; i < n; i++) {
        html += `<th>${experimentData.factors[i].name}</th>`;
    }
    
    html += '<th>Y —ç–∫—Å–ø.</th><th>Y —Ä–∞—Å—á.</th><th>–û—à–∏–±–∫–∞ %</th></tr></thead><tbody>';
    
    for (let i = 0; i < numVer; i++) {
        html += `<tr><td>${i + 1}</td>`;
        
        for (let j = 0; j < n; j++) {
            const factor = experimentData.factors[j];
            html += `<td><input type="number" id="verFactor${i}_${j}" step="0.01" placeholder="${factor.min}-${factor.max}"></td>`;
        }
        
        html += `<td><input type="number" id="verExp${i}" step="0.01"></td>`;
        html += `<td id="verCalc${i}">-</td>`;
        html += `<td id="verError${i}">-</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    document.getElementById('verificationTableContainer').innerHTML = html;
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
function performVerification() {
    const numVer = parseInt(document.getElementById('numVerification').value);
    const n = experimentData.numFactors;
    
    const points = [];
    const results = [];
    let hasAllData = true;
    
    for (let i = 0; i < numVer; i++) {
        const point = [];
        for (let j = 0; j < n; j++) {
            const val = parseFloat(document.getElementById(`verFactor${i}_${j}`).value);
            if (isNaN(val)) {
                hasAllData = false;
                break;
            }
            point.push(val);
        }
        
        const yExp = parseFloat(document.getElementById(`verExp${i}`).value);
        if (isNaN(yExp)) {
            hasAllData = false;
            break;
        }
        
        if (hasAllData) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const codedPoint = point.map((val, j) => {
                const factor = experimentData.factors[j];
                return 2 * (val - factor.min) / (factor.max - factor.min) - 1;
            });
            
            const yCalc = predictValue(codedPoint, true);
            const error = Math.abs((yExp - yCalc) / yExp * 100);
            
            document.getElementById(`verCalc${i}`).textContent = yCalc.toFixed(4);
            document.getElementById(`verError${i}`).textContent = error.toFixed(2) + '%';
            
            points.push(point);
            results.push({ yExp, yCalc, error });
        }
    }
    
    if (!hasAllData) {
        alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã!');
        return;
    }
    
    // –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞
    const avgError = results.reduce((sum, r) => sum + r.error, 0) / results.length;
    
    experimentData.verification = {
        performed: true,
        points: points,
        results: results,
        avgErrorPercent: avgError
    };
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
    let html = '<div class="results" style="margin-top: 20px;">';
    html += '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h4>';
    html += `<p><strong>–°—Ä–µ–¥–Ω—è—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å:</strong> ${avgError.toFixed(2)}%</p>`;
    
    if (avgError < 5) {
        html += '<div class="alert-success">‚úì –û—Ç–ª–∏—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (< 5%)</div>';
    } else if (avgError < 10) {
        html += '<div class="alert-success">‚úì –•–æ—Ä–æ—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (< 10%)</div>';
    } else if (avgError < 15) {
        html += '<div class="alert-warning">‚ö† –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (< 15%)</div>';
    } else {
        html += '<div class="alert-error">‚úó –ú–æ–¥–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è (> 15%)</div>';
    }
    
    html += '</div>';
    document.getElementById('verificationResults').innerHTML = html;
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
function exportToExcel() {
    const n = experimentData.numFactors;
    const numParallel = parseInt(document.getElementById('numParallel').value);
    
    // –õ–∏—Å—Ç 1: –ú–∞—Ç—Ä–∏—Ü–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏
    const data1 = [['–û–ø—ã—Ç']];
    
    for (let i = 0; i < n; i++) {
        data1[0].push(`X${i + 1} (${experimentData.factors[i].name})`);
    }
    
    for (let i = 0; i < numParallel; i++) {
        data1[0].push(`Y${i + 1}`);
    }
    data1[0].push('–°—Ä–µ–¥–Ω–µ–µ');
    
    experimentData.planMatrix.forEach((row, idx) => {
        const dataRow = [row[0]];
        
        for (let i = 1; i <= n; i++) {
            dataRow.push(row[i]);
        }
        
        for (let i = 0; i < numParallel; i++) {
            dataRow.push(experimentData.responses[idx]?.[i] || '');
        }
        
        dataRow.push(calculateAverage(idx).toFixed(3));
        data1.push(dataRow);
    });
    
    // –õ–∏—Å—Ç 2: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
    const data2 = [['–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç', '–ó–Ω–∞—á–µ–Ω–∏–µ', '–ó–Ω–∞—á–∏–º–æ—Å—Ç—å']];
    
    data2.push(['b‚ÇÄ', experimentData.coefficients[0].toFixed(4), experimentData.significantCoeffs[0] ? '–î–∞' : '–ù–µ—Ç']);
    
    for (let i = 0; i < n; i++) {
        data2.push([
            `b${i + 1} (X${i + 1})`,
            experimentData.coefficients[i + 1].toFixed(4),
            experimentData.significantCoeffs[i + 1] ? '–î–∞' : '–ù–µ—Ç'
        ]);
    }
    
    let coeffIdx = n + 1;
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            data2.push([
                `b${i + 1}${j + 1} (X${i + 1}X${j + 1})`,
                experimentData.coefficients[coeffIdx].toFixed(4),
                experimentData.significantCoeffs[coeffIdx] ? '–î–∞' : '–ù–µ—Ç'
            ]);
            coeffIdx++;
        }
    }
    
    // –õ–∏—Å—Ç 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const stats = experimentData.statistics;
    const data3 = [
        ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å', '–ó–Ω–∞—á–µ–Ω–∏–µ'],
        ['–ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞ (G —Ä–∞—Å—á.)', stats.cochranG.toFixed(4)],
        ['–ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞ (G –∫—Ä–∏—Ç.)', stats.cochranCritical.toFixed(4)],
        ['–î–∏—Å–ø–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã', stats.cochranPassed ? '–î–∞' : '–ù–µ—Ç'],
        ['–ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞ (t –∫—Ä–∏—Ç.)', stats.tCritical.toFixed(3)],
        ['–ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞ (F —Ä–∞—Å—á.)', stats.fisherF.toFixed(4)],
        ['–ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞ (F –∫—Ä–∏—Ç.)', stats.fisherCritical.toFixed(4)],
        ['–ú–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞', stats.adequacyPassed ? '–î–∞' : '–ù–µ—Ç'],
        ['–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏ (R¬≤)', stats.rSquared.toFixed(4)]
    ];
    
    // –°–æ–∑–¥–∞–Ω–∏–µ Excel
    const wb = XLSX.utils.book_new();
    
    const ws1 = XLSX.utils.aoa_to_sheet(data1);
    XLSX.utils.book_append_sheet(wb, ws1, '–î–∞–Ω–Ω—ã–µ');
    
    const ws2 = XLSX.utils.aoa_to_sheet(data2);
    XLSX.utils.book_append_sheet(wb, ws2, '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã');
    
    const ws3 = XLSX.utils.aoa_to_sheet(data3);
    XLSX.utils.book_append_sheet(wb, ws3, '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
    
    XLSX.writeFile(wb, `regression_analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('‚úì –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Excel');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel
function loadExcelData() {
    const file = document.getElementById('excelFile').files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (jsonData.length > 1) {
            experimentData.responses = [];
            
            for (let i = 1; i < jsonData.length && i <= experimentData.planMatrix.length; i++) {
                const row = jsonData[i];
                const responses = [];
                
                for (let j = experimentData.numFactors + 1; j < row.length; j++) {
                    if (row[j] !== undefined && row[j] !== '') {
                        responses.push(parseFloat(row[j]));
                    }
                }
                
                experimentData.responses.push(responses);
            }
            
            updateDataTable();
            alert('‚úì –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Excel!');
        }
    };
    reader.readAsArrayBuffer(file);
}

// –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel
function downloadExampleTemplate() {
    const n = experimentData.numFactors;
    const numParallel = parseInt(document.getElementById('numParallel').value);
    
    const data = [['–û–ø—ã—Ç']];
    
    for (let i = 0; i < n; i++) {
        data[0].push(`X${i + 1}`);
    }
    
    for (let i = 0; i < numParallel; i++) {
        data[0].push(`Y${i + 1}`);
    }
    
    experimentData.planMatrix.forEach((row) => {
        const dataRow = [row[0]];
        
        for (let i = 1; i <= n; i++) {
            dataRow.push(row[i]);
        }
        
        for (let i = 0; i < numParallel; i++) {
            dataRow.push('');
        }
        
        data.push(dataRow);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω—ã–µ');
    
    XLSX.writeFile(wb, 'template_regression.xlsx');
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
function downloadReportText() {
    let report = '';
    report += '‚ïê'.repeat(60) + '\n';
    report += '           –û–¢–ß–ï–¢ –ü–û –†–ï–ì–†–ï–°–°–ò–û–ù–ù–û–ú–£ –ê–ù–ê–õ–ò–ó–£\n';
    report += '‚ïê'.repeat(60) + '\n\n';
    
    report += `–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}\n\n`;
    
    report += '1. –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï\n';
    report += '‚îÄ'.repeat(60) + '\n';
    report += `–¢–∏–ø —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞: ${experimentData.type === 'full' ? '–ü–æ–ª–Ω–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π' : '–î—Ä–æ–±–Ω—ã–π'}\n`;
    report += `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤: ${experimentData.numFactors}\n`;
    report += `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—ã—Ç–æ–≤: ${experimentData.planMatrix.length}\n`;
    report += `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø—ã—Ç–æ–≤: ${document.getElementById('numParallel').value}\n\n`;
    
    report += '–§–∞–∫—Ç–æ—Ä—ã:\n';
    experimentData.factors.forEach((f, idx) => {
        report += `  X${idx + 1}: ${f.name} (${f.unit})\n`;
        report += `      –£—Ä–æ–≤–Ω–∏: ${f.min} ... ${f.max}\n`;
    });
    
    report += '\n2. –£–†–ê–í–ù–ï–ù–ò–Ø –†–ï–ì–†–ï–°–°–ò–ò\n';
    report += '‚îÄ'.repeat(60) + '\n';
    report += '–†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:\n';
    report += experimentData.calculatedCodedEquation + '\n\n';
    report += '–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:\n';
    report += experimentData.finalCodedEquation + '\n\n';
    report += '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:\n';
    report += experimentData.finalNaturalEquation + '\n';
    
    report += '\n3. –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó\n';
    report += '‚îÄ'.repeat(60) + '\n';
    const stats = experimentData.statistics;
    
    report += '–ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞:\n';
    report += `  G —Ä–∞—Å—á = ${stats.cochranG.toFixed(4)}\n`;
    report += `  G –∫—Ä–∏—Ç = ${stats.cochranCritical.toFixed(4)}\n`;
    report += `  –†–µ–∑—É–ª—å—Ç–∞—Ç: ${stats.cochranPassed ? '–î–∏—Å–ø–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã ‚úì' : '–î–∏—Å–ø–µ—Ä—Å–∏–∏ –Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω—ã ‚úó'}\n\n`;
    
    report += '–ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞:\n';
    report += `  t –∫—Ä–∏—Ç = ${stats.tCritical.toFixed(3)}\n`;
    report += `  –ó–Ω–∞—á–∏–º—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤: ${stats.significantCoeffs.filter(x => x).length} –∏–∑ ${experimentData.coefficients.length}\n\n`;
    
    report += '–ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞:\n';
    report += `  F —Ä–∞—Å—á = ${stats.fisherF.toFixed(4)}\n`;
    report += `  F –∫—Ä–∏—Ç = ${stats.fisherCritical.toFixed(4)}\n`;
    report += `  –†–µ–∑—É–ª—å—Ç–∞—Ç: ${stats.adequacyPassed ? '–ú–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞ ‚úì' : '–ú–æ–¥–µ–ª—å –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞ ‚úó'}\n\n`;
    
    report += '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏:\n';
    report += `  R¬≤ = ${stats.rSquared.toFixed(4)} (${(stats.rSquared * 100).toFixed(2)}%)\n`;
    
    report += '\n4. –í–´–í–û–î–´\n';
    report += '‚îÄ'.repeat(60) + '\n';
    report += `–ü–æ–ª—É—á–µ–Ω–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ —Å ${experimentData.numFactors} —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏.\n`;
    
    if (stats.rSquared > 0.9) {
        report += '–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏: –æ—Ç–ª–∏—á–Ω–æ–µ (R¬≤ > 0.9)\n';
    } else if (stats.rSquared > 0.7) {
        report += '–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏: —Ö–æ—Ä–æ—à–µ–µ (R¬≤ > 0.7)\n';
    } else {
        report += '–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏: —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ\n';
    }
    
    if (stats.adequacyPassed) {
        report += '–ú–æ–¥–µ–ª—å –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å.\n';
    } else {
        report += '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å –º–æ–¥–µ–ª—å.\n';
    }
    
    if (experimentData.verification.performed) {
        report += `\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–º:\n`;
        report += `  –°—Ä–µ–¥–Ω—è—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å: ${experimentData.verification.avgErrorPercent.toFixed(2)}%\n`;
    }
    
    report += '\n' + '‚ïê'.repeat(60) + '\n';
    
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regression_report_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// –≠–∫—Å–ø–æ—Ä—Ç HTML –æ—Ç—á–µ—Ç–∞
function downloadReportHTML() {
    const html = `<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–û—Ç—á–µ—Ç –ø–æ —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É</title>
<style>
body {
    font-family: 'Segoe UI', Arial, sans-serif;
    padding: 40px;
    max-width: 1000px;
    margin: 0 auto;
    background: #f5f5f5;
}
h1 {
    color: #d4af37;
    text-align: center;
    border-bottom: 3px solid #d4af37;
    padding-bottom: 15px;
}
h2 {
    color: #0f3460;
    margin-top: 30px;
    border-bottom: 2px solid #d4af37;
    padding-bottom: 10px;
}
h3 {
    color: #16213e;
    margin-top: 20px;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}
th {
    background: #d4af37;
    color: white;
    font-weight: bold;
}
tr:nth-child(even) {
    background: #f9f9f9;
}
.equation {
    background: #f5f5f5;
    padding: 15px;
    border-left: 5px solid #d4af37;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
}
.passed {
    color: green;
    font-weight: bold;
}
.failed {
    color: red;
    font-weight: bold;
}
.info-box {
    background: #e3f2fd;
    border-left: 5px solid #2196f3;
    padding: 15px;
    margin: 15px 0;
}
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}
.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-card h4 {
    color: #d4af37;
    margin-bottom: 10px;
}
@media print {
    body { background: white; }
}
</style>
</head>
<body>
<h1>üìä –û—Ç—á–µ—Ç –ø–æ —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É</h1>
<p style="text-align:center"><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleString('ru-RU')}</p>

<h2>1. –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
<p><strong>–¢–∏–ø —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</strong> ${experimentData.type === 'full' ? '–ü–æ–ª–Ω–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π (–ü–§–≠)' : '–î—Ä–æ–±–Ω—ã–π (–î–§–≠)'}</p>
<p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤:</strong> ${experimentData.numFactors}</p>
<p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—ã—Ç–æ–≤:</strong> ${experimentData.planMatrix.length}</p>

<h3>–§–∞–∫—Ç–æ—Ä—ã:</h3>
<table>
<tr><th>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ï–¥–∏–Ω–∏—Ü–∞</th><th>–ú–∏–Ω–∏–º—É–º</th><th>–ú–∞–∫—Å–∏–º—É–º</th></tr>
${experimentData.factors.map((f, i) => `
<tr><td>X${i + 1}</td><td>${f.name}</td><td>${f.unit}</td><td>${f.min}</td><td>${f.max}</td></tr>
`).join('')}
</table>

<h2>2. –†–∞—Å—á–µ—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏</h2>
<div class="equation">
<strong>–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ:</strong><br>
${experimentData.calculatedCodedEquation}
</div>
<div class="equation">
<strong>–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ:</strong><br>
${experimentData.calculatedNaturalEquation}
</div>

<h2>3. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ (–∑–Ω–∞—á–∏–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)</h2>
<div class="equation">
<strong>–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ:</strong><br>
${experimentData.finalCodedEquation}
</div>
<div class="equation">
<strong>–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ:</strong><br>
${experimentData.finalNaturalEquation}
</div>

<h2>4. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</h2>
<div class="stats-grid">
<div class="stat-card">
<h4>–ö—Ä–∏—Ç–µ—Ä–∏–π –ö–æ—Ö—Ä–µ–Ω–∞</h4>
<p>G —Ä–∞—Å—á = ${experimentData.statistics.cochranG.toFixed(4)}</p>
<p>G –∫—Ä–∏—Ç = ${experimentData.statistics.cochranCritical.toFixed(4)}</p>
<p class="${experimentData.statistics.cochranPassed ? 'passed' : 'failed'}">
${experimentData.statistics.cochranPassed ? '‚úì –î–∏—Å–ø–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã' : '‚úó –î–∏—Å–ø–µ—Ä—Å–∏–∏ –Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω—ã'}
</p>
</div>

<div class="stat-card">
<h4>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏</h4>
<p style="font-size:2em;color:#d4af37"><strong>R¬≤ = ${experimentData.statistics.rSquared.toFixed(4)}</strong></p>
<p>${(experimentData.statistics.rSquared * 100).toFixed(2)}% –æ–±—ä—è—Å–Ω–µ–Ω–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏</p>
</div>

<div class="stat-card">
<h4>–ö—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞</h4>
<p>t –∫—Ä–∏—Ç = ${experimentData.statistics.tCritical.toFixed(3)}</p>
<p>–ó–Ω–∞—á–∏–º—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤: ${experimentData.statistics.significantCoeffs.filter(x => x).length} –∏–∑ ${experimentData.coefficients.length}</p>
</div>

<div class="stat-card">
<h4>–ö—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞</h4>
<p>F —Ä–∞—Å—á = ${experimentData.statistics.fisherF.toFixed(4)}</p>
<p>F –∫—Ä–∏—Ç = ${experimentData.statistics.fisherCritical.toFixed(4)}</p>
<p class="${experimentData.statistics.adequacyPassed ? 'passed' : 'failed'}">
${experimentData.statistics.adequacyPassed ? '‚úì –ú–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞' : '‚úó –ú–æ–¥–µ–ª—å –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞'}
</p>
</div>
</div>

${experimentData.verification.performed ? `
<h2>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–º</h2>
<p><strong>–°—Ä–µ–¥–Ω—è—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å:</strong> ${experimentData.verification.avgErrorPercent.toFixed(2)}%</p>
<p class="${experimentData.verification.avgErrorPercent < 10 ? 'passed' : 'failed'}">
${experimentData.verification.avgErrorPercent < 5 ? '–û—Ç–ª–∏—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å' :
  experimentData.verification.avgErrorPercent < 10 ? '–•–æ—Ä–æ—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å' : '–¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ'}
</p>
` : ''}

<h2>–í—ã–≤–æ–¥—ã</h2>
<p>–ú–æ–¥–µ–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç ${experimentData.significantCoeffs.filter(x => x).length} –∑–Ω–∞—á–∏–º—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –∏–∑ ${experimentData.coefficients.length} —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö.</p>
${experimentData.statistics.adequacyPassed ?
'<p class="passed">–ú–æ–¥–µ–ª—å –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è.</p>' :
'<p class="failed">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å –º–æ–¥–µ–ª—å.</p>'}
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regression_report_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
function exportToJSON() {
    const exportData = {
        timestamp: new Date().toISOString(),
        type: experimentData.type,
        numFactors: experimentData.numFactors,
        factors: experimentData.factors,
        planMatrix: experimentData.planMatrix,
        responses: experimentData.responses,
        numParallel: parseInt(document.getElementById('numParallel').value),
        coefficients: experimentData.coefficients,
        significantCoeffs: experimentData.significantCoeffs,
        calculatedCodedEquation: experimentData.calculatedCodedEquation,
        calculatedNaturalEquation: experimentData.calculatedNaturalEquation,
        finalCodedEquation: experimentData.finalCodedEquation,
        finalNaturalEquation: experimentData.finalNaturalEquation,
        statistics: experimentData.statistics,
        verification: experimentData.verification
    };
    
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regression_data_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('‚úì –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON');
}

// –ò–º–ø–æ—Ä—Ç –∏–∑ JSON
function importFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            
            experimentData.type = importData.type || 'full';
            experimentData.numFactors = importData.numFactors || 3;
            experimentData.factors = importData.factors || [];
            experimentData.planMatrix = importData.planMatrix || [];
            experimentData.responses = importData.responses || [];
            experimentData.coefficients = importData.coefficients || [];
            experimentData.significantCoeffs = importData.significantCoeffs || [];
            experimentData.calculatedCodedEquation = importData.calculatedCodedEquation || '';
            experimentData.calculatedNaturalEquation = importData.calculatedNaturalEquation || '';
            experimentData.finalCodedEquation = importData.finalCodedEquation || '';
            experimentData.finalNaturalEquation = importData.finalNaturalEquation || '';
            experimentData.statistics = importData.statistics || {};
            experimentData.verification = importData.verification || { performed: false, points: [], results: [] };
            
            document.getElementById('numFactors').value = experimentData.numFactors;
            if (importData.numParallel) {
                document.getElementById('numParallel').value = importData.numParallel;
            }
            document.querySelector(`input[name="experimentType"][value="${experimentData.type}"]`).checked = true;
            
            setupFactors();
            
            setTimeout(() => {
                experimentData.factors.forEach((f, idx) => {
                    document.getElementById(`factorName${idx}`).value = f.name;
                    document.getElementById(`factorUnit${idx}`).value = f.unit;
                    document.getElementById(`factorMin${idx}`).value = f.min;
                    document.getElementById(`factorMax${idx}`).value = f.max;
                });
                
                generatePlan();
                
                setTimeout(() => {
                    updateDataTable();
                    
                    if (importData.statistics && Object.keys(importData.statistics).length > 0) {
                        displayStatisticalResults();
                        displayCoefficientsTable();
                        generateAllEquations();
                        generateGraphSelection();
                        document.getElementById('step4').classList.remove('hidden');
                    }
                }, 100);
            }, 100);
            
            alert('‚úì –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ JSON');
        } catch (err) {
            alert('‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ JSON: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeModal() {
    document.getElementById('chartModal').style.display = 'none';
}

window.onclick = (event) => {
    const modal = document.getElementById('chartModal');
    if (event.target === modal) {
        closeModal();
    }
};

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
function getCochranCritical(n, m) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è Œ±=0.05
    const table = {
        2: { 2: 0.9750, 3: 0.9392, 4: 0.9057, 5: 0.8772 },
        4: { 2: 0.8709, 3: 0.7977, 4: 0.7457, 5: 0.7071 },
        8: { 2: 0.6798, 3: 0.5981, 4: 0.5441, 5: 0.5065 },
        16: { 2: 0.4884, 3: 0.4156, 4: 0.3720, 5: 0.3423 }
    };
    
    const nKey = n <= 2 ? 2 : n <= 4 ? 4 : n <= 8 ? 8 : 16;
    const mKey = m <= 2 ? 2 : m <= 3 ? 3 : m <= 4 ? 4 : 5;
    
    return table[nKey]?.[mKey] || 0.5;
}

function getTCritical(df) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è Œ±=0.05, –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Ç–µ—Å—Ç
    const table = {
        5: 2.571, 10: 2.228, 15: 2.131, 20: 2.086, 30: 2.042, 60: 2.000, 120: 1.980
    };
    
    const key = df <= 5 ? 5 : df <= 10 ? 10 : df <= 15 ? 15 : df <= 20 ? 20 : 
                df <= 30 ? 30 : df <= 60 ? 60 : 120;
    
    return table[key] || 1.960;
}

function getFCritical(df1, df2) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è Œ±=0.05
    if (df1 <= 0 || df2 <= 0) return Infinity;
    
    const table = {
        1: { 5: 6.61, 10: 4.96, 20: 4.35, 30: 4.17, 60: 4.00 },
        2: { 5: 5.79, 10: 4.10, 20: 3.49, 30: 3.32, 60: 3.15 },
        5: { 5: 5.05, 10: 3.33, 20: 2.71, 30: 2.53, 60: 2.37 },
        10: { 5: 4.74, 10: 2.98, 20: 2.35, 30: 2.16, 60: 1.99 }
    };
    
    const df1Key = df1 <= 1 ? 1 : df1 <= 2 ? 2 : df1 <= 5 ? 5 : 10;
    const df2Key = df2 <= 5 ? 5 : df2 <= 10 ? 10 : df2 <= 20 ? 20 : df2 <= 30 ? 30 : 60;
    
    return table[df1Key]?.[df2Key] || 2.5;
}
</script>
</body>
</html>